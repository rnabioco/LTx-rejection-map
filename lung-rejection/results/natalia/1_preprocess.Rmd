---
title: "Lung rejection scRNA-seq data preprocessing"
author: "Kent Riemondy RBI"
date: "`R Sys.Date()`"
params:
  ncores: 4
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cosmo
    highlight: tango
    fig_caption: true
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(cache.lazy = FALSE)
```


```{r libs, message=FALSE, warning=FALSE, echo=FALSE}
source(here::here("R/utils.R"))
library(future)

plan("multicore", workers = 7)
options(future.globals.maxSize = 2 * 1024 ^ 3)

proj_dir <- here()
data_dir <- file.path(proj_dir, "data", "cellranger", "results")
doc_dir <- file.path(proj_dir, "docs")

fig_dir <- "figs_2"
mkrs_dir <- "markers_2"
tbls_dir <- "tables_2"
object_dir <- "objects_2"
walk(c(fig_dir, mkrs_dir, tbls_dir, object_dir), 
     dir.create, showWarnings = F)
```

# Experiment Summary

```{r get_data}

samples_1 <- paste0("Eickelberg_", 
                  c("B6B6_1",
                    "B6B6_2",
                    "B6B6_3",
                    "HLAB6_2", 
                    "HLAB6_3"))

samples_2 <- c(
  "1_B_65_11152018",
  "1_B6_B6_11132018",
  "2_HLA_5_11152018")

samples <- c(samples_1, samples_2)

sample_paths <- file.path(data_dir,
                          samples,
                          "outs", 
                          "filtered_feature_bc_matrix")

names(sample_paths) <- c(str_remove(samples_1, "Eickelberg_"),
                         "B6B6_5",
                         "B6B6_4",
                         "HLAB6_5")

mat <- Read10X(sample_paths)
```

## General QC for library prep  {.tabset}

```{r }
metrics_paths <- file.path(data_dir,
                          samples,
                          "outs", 
                          "metrics_summary.csv")

names(metrics_paths) <- str_remove(samples, "Eickelberg_")

mapping_dat <- map_dfr(metrics_paths, read_csv, .id = "sample")

clean_up_metadata <- function(metrics_summary) {
  metrics_summary <- mutate_all(metrics_summary, str_remove, "%$")
  metrics_summary <- mutate_at(metrics_summary, .vars= 2:ncol(metrics_summary), as.numeric)
  metrics_summary
}

mapping_dat <- clean_up_metadata(mapping_dat)

metrics <- colnames(mapping_dat)[2:ncol(mapping_dat)]

mapping_dat <- mapping_dat %>% 
  gather(metric, value, -sample) %>%
  mutate(sample = factor(sample, levels = unique(sample)))

p <- map(metrics, 
    function(x) {
    filter(mapping_dat, metric == x) %>% 
          ggplot(aes(sample, value)) +
            geom_point(aes(color = sample)) +
        scale_color_brewer(palette = "Paired") + 
        labs(y = x, 
             x = "") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
}) 
```

```{r, results ='asis'}

for(i in seq_along(p)){
  cat('\n### ', metrics[i], '\n')
  print(p[i])
  cat('\n')
}
```


## Preprocessing {.tabset}


## Rerun preprocessing scaling, PCA, UMAP, etc. 
    
```{r create_seurat, message = F, results = 'hide', warning = F}

so <- CreateSeuratObject(
  mat,
  min.cells = 3,
  min.features = 200,
  names.delim = "_",
  names.field = c(1,2)
)

so <- PercentageFeatureSet(so, 
                             pattern = "^mt-", 
                             col.name = "percent.mt")

so@meta.data <- so@meta.data %>% 
  tibble::rownames_to_column("cell") %>% 
  mutate(condition = str_remove(orig.ident, "_[0-9]")) %>% 
  as.data.frame() %>% 
  tibble::column_to_rownames("cell")


dir.create(object_dir, showWarnings = FALSE)

saveRDS(so, file.path(object_dir, "unfiltered.rds"))
```

### Percent Mitochondrial UMIs 

```{r}
plot_violin(so@meta.data, 
            "orig.ident",
            "percent.mt",
            .fill = "condition") +
  labs(x = "", y = "Percent UMIs from Mitochondria")
```


### # of genes detected 

```{r}
plot_violin(so@meta.data,
            "orig.ident", 
            "nFeature_RNA",
            .fill = "condition") +
  labs(x = "", y = "# of genes per cell")
```


### # of UMIs detected

```{r}
plot_violin(so@meta.data, 
            "orig.ident",
            "nCount_RNA", 
            .fill = "condition") +
  labs(x = "", y = "# of UMIs") 
```

### Table of mitochondrial proportions per sample

```{r}
so@meta.data %>% 
  group_by(orig.ident) %>% 
  summarize(median_percent_mito = median(percent.mt), 
            mean_percent_mito = mean(percent.mt)) %>% 
  arrange(desc(median_percent_mito))

```


## Relationship between UMIs and % mitochondria {.tabset}

### All samples

```{r, fig.width = 24, fig.height = 18}
sample_names <- as.character(unique(so@meta.data$orig.ident))
per_sample <- map(sample_names, ~filter(so@meta.data, 
                                        orig.ident == .x))
p <- list()
for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  p[[i]] <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = condition)) +
        scale_color_manual(values = .col)
}

plot_grid(plotlist= p, nrow = 2, ncol = 3)
```

```{r, results ='asis'}

for(i in seq_along(per_sample)){
  .col <- discrete_palette_default[i]
  cat('\n### ', sample_names[i], '\n')
  p <- ggplot(per_sample[[i]], aes(nCount_RNA, percent.mt)) +
        geom_point(aes(color = condition)) +
        scale_color_manual(values = .col)
  print(p)
  cat('\n')
}
```


## Filter cells and samples.

No filtering applied at this point.

```{r}
so <- readRDS(file.path(object_dir, "unfiltered.rds"))
```


Annotate samples and assign colors to each sample. 

```{r}
annots <- so@meta.data %>% 
  select(orig.ident, condition) %>% 
  unique() %>%
  arrange(condition)

subgroup_order <- c(
  "B6B6",
  "HLAB6"
)

annots <- mutate(annots, condition = factor(condition, levels = subgroup_order))

sample_order <- annots$orig.ident 

so@meta.data$orig.ident <- factor(so@meta.data$orig.ident, levels = sample_order)
so@meta.data$condition <- factor(so@meta.data$condition, levels = subgroup_order)

```


## Normalize and embed into 2D with UMAP

```{r}

so <- NormalizeData(so)

so <- FindVariableFeatures(
  so,
  selection.method = "vst",
  nfeatures = 2000,
  verbose = FALSE
)

so <- ScaleData(so, verbose = TRUE)

so <- RunPCA(so, 
             npcs = 100, 
             verbose = FALSE)

ElbowPlot(so, ndims = 100)

# make graphs and use graphs for UMAP
so <- FindNeighbors(so, 
                      reduction = "pca", 
                      dims = 1:30, 
                      k.param = 20L)


so <- RunUMAP(so, 
              graph = "RNA_snn", 
              min.dist = 0.3)

so <- FindClusters(so, 
                   resolution = c(0.05, 0.075, 0.1, 0.3, 0.5))

so$coarse_clusters <- so$RNA_snn_res.0.075

Idents(so) <- "coarse_clusters"

plot_umap(so, "coarse_clusters")
```

```{r}

plot_umap(so, "condition", .col = palette_OkabeIto)
plot_umap(so, "coarse_clusters", label_text = TRUE, label_col = "black")
plot_umap(so, "orig.ident")
```


```{r}
saveRDS(so, file.path(object_dir, "so.rds"))
```

## markers 


### Cluster markers
```{r}
so <- readRDS(file.path(object_dir, "so.rds"))
mkrs <- FindAllMarkers(so, only.pos = TRUE)

write_tsv(mkrs, 
          file.path(mkrs_dir, "coarse_cluster_markers_all_data.tsv"))
```


### DE genes between conditions

Skip cluster 7 as only B6B6

```{r}
so$cluster_condition <- str_c(so$condition, "_", so$coarse_clusters)

clusters_to_test <- sort(unique(so$coarse_clusters))

clusters_to_test <- clusters_to_test[clusters_to_test != "7"]

Idents(so) <- "cluster_condition"
mkrs <- list()
for (i in seq_along(clusters_to_test)){
  message(clusters_to_test[i]) 
  mkrs[[i]] <- FindMarkers(so, 
              ident.1 = str_c("HLAB6_", clusters_to_test[i]),
              ident.2 = str_c("B6B6_", clusters_to_test[i]), 
              only.pos = FALSE)
}

names(mkrs) <- clusters_to_test

mkrs <- map(mkrs, ~tibble::rownames_to_column(.x, "gene"))
mkrs <- bind_rows(mkrs, .id = "cluster")

write_tsv(mkrs, 
          file.path(mkrs_dir, "coarse_cluster_deg_conditions.tsv"))
```



```{r}
so <- readRDS(file.path(object_dir, "so.rds"))
mkrs <- read_tsv(file.path(mkrs_dir, "coarse_cluster_markers_all_data.tsv"))

topx <- mkrs %>% 
  group_by(cluster) %>% 
  top_n(10, avg_logFC) 
```



```{r, fig.width = 20, fig.height= 20}

p <- DotPlot(so, 
        features = unique(topx$gene),
        group.by = "coarse_clusters") +
  coord_flip() +
  labs(x = "Cluster",
       y = "")

p

save_plot(file.path(fig_dir, 
                    "coarse_cluster_marker_dotplot.pdf"), 
          p, base_height = 24, base_asp = 1)
```



## Try to assign cell types using cell atlas data

The [`Tabula Muris`](https://tabula-muris.ds.czbiohub.org/) is a collection of single cell dataset from 20 organs. 

We will use the gene expression profiles from these datasets to try to assign cell types to the identified clusters. The `clustifyr` package will correlate experession in our clusters to the tabula muris and report the most correlated cell type. It's unlikely that these will be 100% correct, because I don't believe that the tabula muris will have all of the cell types in a mouse, and I don't believe hat they have cells from developing tissues. Nevertheless it will give us a good starting point to annotating the cell types. 

```{r, fig.width=8, fig.height=12}
library(clustifyr)
library(ComplexHeatmap)

so <- readRDS(file.path(object_dir, "so.rds"))

tm_average <- readRDS("/Users/kriemo/Projects/sc_repos/vanotterloo/data/tabula_muris/TM_avg_expr.rds")

mdata <- get_metadata(so)

res <- clustify(so@assays$RNA@data, 
                tm_average, 
                query_genes = so@assays$RNA@var.features,
                metadata = mdata, 
                cluster_col = "coarse_clusters", 
                compute_method = "spearman")

hmap <- Heatmap(t(res), 
                viridis::viridis(256), 
                "Spearman\ncorrelation",
                row_title = "Cell types from Tabula Muris",
                column_title = "Clusters")
  
pdf(file.path(fig_dir, "cell_type_heatmap.pdf"), height = 12, width = 12)
draw(hmap)
dev.off()

hmap


so$cell_types <- call_to_metadata(cor_to_call(res, 
                             metadata = mdata, 
                             cluster_col = "coarse_clusters", threshold = 0.5),
                 metadata = mdata,
                 cluster_col = "coarse_clusters") %>% 
  pull(type)

# manually annotation Mzb1+ cells

so$cell_types <- ifelse(so$coarse_clusters == "11", 
                        "B cell Mzb1+",
                        so$cell_types)
```


```{r}
pclusters <- plot_umap(so, "coarse_clusters")
pcell_types <- plot_umap(so, "cell_types")

plt <- plot_grid(pclusters, pcell_types)
save_plot(file.path(fig_dir,"umap_by_cell_type.pdf"),
          plt, nrow = 1, ncol = 2, base_asp = 1.75)

saveRDS(so, file.path(object_dir, "so.rds"))
```


## Decontaminaiton with SoupX

```{r}
library(SoupX)

dataDirs <- file.path(data_dir, samples, "outs")
scl <- load10X(dataDirs)
scl <- inferNonExpressedGenes(scl)

map(str_c("Channel", 1:8),
  ~rownames(scl$channels[[.x]]$nonExpressedGenes)[seq(50)]
) %>% 
  unlist() %>% 
  unique() %>% 
  .[!str_detect(., "^Rp[ls]")] %>% 
  .[!str_detect(., "^mt")]

soup_genes <- list(
  HB = c("Hbb-bs", "Hba-a1", "Hba-a2", "Hbb-bt", "H2-Ab1", "H2-Aa", "H2-Ab1", "H2-Eb1"),
  Club = c("Scgb1a1"),
  Bcell = c("Cd74", "Ighg2c", "Igkc", "Ighm", "Ighg3"),
  AEC2 = c("Sftpc"),
  MAC = c("Apoe", "Lyz2", "Psap" ),
  OTHER = c("Ly6c1", "Ly6a" )
)


for(channel in str_c("Channel", 1:8)){
  scl <- calculateContaminationFraction(scl, channel, soup_genes)
}

for(channel in str_c("Channel", 1:8)){
  gg = plotChannelContamination(scl, channel)
  plot(gg)
}

for(channel in str_c("Channel", 1:8)){
  scl = interpolateCellContamination(scl, channel, useGlobal = FALSE)
}

scl = strainCells(scl)
scl = adjustCounts(scl)

rename_cols <- c(str_remove(samples_1, "Eickelberg_"),
                         "B6B6_5",
                         "B6B6_4",
                         "HLAB6_5")

names(rename_cols) <- str_c("Channel", 1:8)

count_matrix <- scl$atoc


channels <- colnames(count_matrix) %>% 
  str_match("Channel[0-9]") %>%
  .[, 1]

new_ids <- rename_cols[channels]

cell_ids <- str_remove(colnames(count_matrix),
                       "Channel[0-9]___")

new_ids <- str_c(new_ids, "_", cell_ids) %>% 
  str_remove("-[0-9]$")

colnames(count_matrix) <- new_ids
```

## renormalize/cluster/embed via seurat

```{r}
count_matrix <- count_matrix[rownames(so), colnames(so)]

cell_types <- so$cell_types
so <- CreateSeuratObject(counts = count_matrix , 
                         names.field = c(1, 2))

so$cell_types <- cell_types
so$condition <- str_remove(so$orig.ident, "_[0-9]$")
so <- NormalizeData(so)

so <- FindVariableFeatures(
  so,
  selection.method = "vst",
  nfeatures = 2000,
  verbose = FALSE
)

so <- ScaleData(so, verbose = TRUE)

so <- RunPCA(so, 
             npcs = 100, 
             verbose = FALSE)

ElbowPlot(so, ndims = 100)

# make graphs and use graphs for UMAP
so <- FindNeighbors(so, 
                      reduction = "pca", 
                      dims = 1:30, 
                      k.param = 20L)


so <- RunUMAP(so, 
              graph = "RNA_snn", 
              min.dist = 0.3)

so <- FindClusters(so, 
                   resolution = c(0.05, 0.075, 0.1, 0.3, 0.5))

so$coarse_clusters <- so$RNA_snn_res.0.075

Idents(so) <- "coarse_clusters"

plot_umap(so, "coarse_clusters")
plot_umap(so, "cell_types")
```

Assign cell types to souped data

```{r}
tm_average <- readRDS("/Users/kriemo/Projects/sc_repos/vanotterloo/data/tabula_muris/TM_avg_expr.rds")

mdata <- get_metadata(so)

res <- clustify(so@assays$RNA@data, 
                tm_average, 
                query_genes = so@assays$RNA@var.features,
                metadata = mdata, 
                cluster_col = "coarse_clusters", 
                compute_method = "spearman")

hmap <- Heatmap(t(res), 
                viridis::viridis(256), 
                "Spearman\ncorrelation",
                row_title = "Cell types from Tabula Muris",
                column_title = "Clusters")
  
pdf(file.path(fig_dir, "cell_type_heatmap_soupx.pdf"), height = 12, width = 12)
draw(hmap)
dev.off()

hmap


so$cell_types <- call_to_metadata(cor_to_call(res, 
                             metadata = mdata, 
                             cluster_col = "coarse_clusters", threshold = 0.5),
                 metadata = mdata,
                 cluster_col = "coarse_clusters") %>% 
  pull(type)

# manually annotation Mzb1+ cells

so$cell_types <- ifelse(so$coarse_clusters == "11", 
                        "B cell Mzb1+",
                        so$cell_types)
```

```{r}
saveRDS(so, file.path(object_dir, "so_souped.rds"))
```

```{r}
to_plot <- c(
  "coarse_clusters",
  "cell_types",
  "condition",
  "orig.ident"
) 

plt <- map(to_plot, 
    ~plot_umap(so, .x)) %>% 
  plot_grid(plotlist = ., nrow = 1, ncol =4,
            rel_widths = c(1.2, 2, 1.2, 1.2))


save_plot(file.path(fig_dir,
                         paste0("umap_summary_soupx.pdf")),
                plt,
          nrow = 1, 
          ncol = 4,
                base_asp = 1.2)
```
## markers 


### Cluster markers
```{r}
so <- readRDS(file.path(object_dir, "so_souped.rds"))

mkrs <- FindAllMarkers(so, only.pos = TRUE)

write_tsv(mkrs, 
          file.path(mkrs_dir, "coarse_cluster_markers_all_data_soupx.tsv"))
```


### DE genes between conditions

```{r}

so$cluster_condition <- str_c(so$condition, "_", so$coarse_clusters)

clusters_to_test <- sort(unique(so$coarse_clusters))
clusters_to_test <- clusters_to_test[clusters_to_test != "7"]

Idents(so) <- "cluster_condition"
mkrs <- list()
for (i in seq_along(clusters_to_test)){
  message(clusters_to_test[i]) 
  mkrs[[i]] <- FindMarkers(so, 
              ident.1 = str_c("HLAB6_", clusters_to_test[i]),
              ident.2 = str_c("B6B6_", clusters_to_test[i]), 
              only.pos = FALSE)
}

names(mkrs) <- clusters_to_test

mkrs <- map(mkrs, ~tibble::rownames_to_column(.x, "gene"))
mkrs <- bind_rows(mkrs, .id = "cluster")

write_tsv(mkrs, 
          file.path(mkrs_dir, "coarse_cluster_deg_conditions_soupx.tsv"))
```


### DE genes between b-cells/mzb1 b-cells

```{r}
deg_genes <- read_tsv(file.path(mkrs_dir, "coarse_cluster_deg_conditions_soupx.tsv"))

cluster_to_plot <- 11

top_n_genes <- filter(deg_genes, cluster == cluster_to_plot) %>% 
  arrange(p_val_adj) %>% 
  slice(1:25) %>% 
  pull(gene)

count_mat <- so@assays$RNA@data[top_n_genes, 
                                so$coarse_clusters == cluster_to_plot]

scale_mat <- t(scale(t(as.matrix(count_mat))))

simple_annots <- so@meta.data[colnames(count_mat),
                                          c("cell_types",
                                            "coarse_clusters",
                                            "condition")]

cell_id_order <- simple_annots %>% 
  rownames_to_column("cell") %>% 
  arrange(condition) %>% 
  pull(cell)

ha <- HeatmapAnnotation(df = simple_annots)

Heatmap(scale_mat, 
        name = "z-score",
        column_order = cell_id_order,
        show_column_names = FALSE, 
        top_annotation = ha)
```


```{r}
deg_genes <- read_tsv(file.path(mkrs_dir, "coarse_cluster_deg_conditions_soupx.tsv"))

cluster_to_plot <- 8

top_n_genes <- filter(deg_genes, cluster == cluster_to_plot) %>% 
  arrange(p_val_adj) %>% 
  slice(1:25) %>% 
  pull(gene)

count_mat <- so@assays$RNA@data[top_n_genes, 
                                so$coarse_clusters == cluster_to_plot]

scale_mat <- t(scale(t(as.matrix(count_mat))))

simple_annots <- so@meta.data[colnames(count_mat),
                                          c("cell_types",
                                            "coarse_clusters",
                                            "condition")]

cell_id_order <- simple_annots %>% 
  rownames_to_column("cell") %>% 
  arrange(condition) %>% 
  pull(cell)

ha <- HeatmapAnnotation(df = simple_annots)

Heatmap(scale_mat, 
        name = "z-score",
        column_order = cell_id_order,
        show_column_names = FALSE, 
        top_annotation = ha)
```

## Summary UMAPs


```{r}

to_plot <- c(
  "coarse_clusters",
  "cell_types",
  "condition"
) 

plt <- map(to_plot, 
    ~plot_umap(so, .x)) %>% 
  plot_grid(plotlist = ., nrow = 1, ncol =3)


save_plot(file.path(fig_dir,
                         paste0("umap_summary_soupx.pdf")),
                plt,
                base_asp = 1.2)
```



## Xcel spreadsheets

```{r}
write_markers_xlsx <- function(mrkr_list, 
                               path, 
                               description_string = "Genes differentially expressed between each cluster and all other cells"){
  
readme_sheet <- tibble(
  Columns = c(
  description_string,
  "",
  "Columns",
  "pval",
  "avg_logFC",
  "pct.1",
  "pct.2",
  "p_val_adj",
  "cluster",
  "gene"
), Description = c(
  "",
  "",
  "",
  "p-value from wilcox test of indicated cluster compared to other clusters",
  "average fold change expressed in natural log",
  "percent of cells expressing gene (UMI > 0) in cluster",
  "percent of cell expressing gene (UMI > 0) in all other clusters",
  "Bonferroni corrected p-value",
  "cluster name",
  "gene name"
))
  readme_sheet <- list(README = readme_sheet)
  names(readme_sheet) <- "README"
       
  xcel_out <- map(mrkr_list, 
                         ~set_xlsx_class(.x, "gene", "Text"))
  
  xcel_out <- c(readme_sheet,  xcel_out)
              
  openxlsx::write.xlsx(xcel_out, 
                       path)
  
}


between_clusters_description <- "Genes differentially expressed between rejected and non-rejecting lungs for each cluster"

deg_genes <- read_tsv(file.path(mkrs_dir, "coarse_cluster_deg_conditions_soupx.tsv"))

write_markers_xlsx(split(deg_genes, deg_genes$cluster),
                   file.path(mkrs_dir, "coarse_cluster_deg_conditions_soupx.xlsx"),
                   between_clusters_description)

deg_genes <- read_tsv(file.path(mkrs_dir, "coarse_cluster_deg_conditions.tsv"))

write_markers_xlsx(split(deg_genes, deg_genes$cluster),
                   file.path(mkrs_dir, "coarse_cluster_deg_conditions.xlsx"),
                   between_clusters_description)

cluster_markers <- read_tsv(file.path(mkrs_dir, "coarse_cluster_markers_all_data.tsv"))

write_markers_xlsx(split(cluster_markers, cluster_markers$cluster),
                   file.path(mkrs_dir, "coarse_cluster_markers.xlsx"))


cluster_markers <- read_tsv(file.path(mkrs_dir, "coarse_cluster_markers_all_data_soupx.tsv"))

write_markers_xlsx(split(cluster_markers, cluster_markers$cluster),
                   file.path(mkrs_dir, "coarse_cluster_markers_soupx.xlsx"))

```


## Overlay human HLA-A2 expression

```{r, fig.width = 12}
so <- readRDS(file.path(object_dir, "so_souped.rds"))

count_path <- file.path(proj_dir, 
                        "data",
                        "cellranger",
                        "hlaa2_mapping")
count_files <- file.path(count_path, paste0(samples, "_counts.txt"))

all(map_lgl(count_files, file.exists))

names(count_files) <- c(str_remove(samples_1, "Eickelberg_"),
                         "B6B6_5",
                         "B6B6_4",
                         "HLAB6_5")

hla_counts <- map_dfr(count_files, read_tsv,
                  col_names = c("cell", "hla_counts"),
                  .id = "sample") %>% 
  mutate(cell = paste0(sample, "_", cell))


so$hla_counts <- left_join(rownames_to_column(so@meta.data,
                                              "cell"),
                           hla_counts) %>% 
  mutate(hla_counts = ifelse(is.na(hla_counts),
                             0L,
                             hla_counts),
         hla_counts = log1p(1e4 * (hla_counts / nCount_RNA))) %>% 
  pull(hla_counts)
  

plot_umap(so, "cell_types")

plot_umap(so, "hla_counts")

so@meta.data %>% 
  ggplot(aes(cell_types, hla_counts)) +
  geom_violin(aes(fill = condition)) +
  geom_jitter(aes(color = condition)) + 
  theme(axis.text.x = element_text(angle = 90))

p <- plot_features_split(so, "hla_counts", "condition") %>% 
  plot_grid(plotlist = .)

save_plot(file.path(fig_dir, "human_hla_tg_umaps.pdf"), 
          p,
          nrow = 1, ncol = 2)

saveRDS(so, file.path(object_dir, "so_souped.rds"))
```


```{r}
get_metadata(so) %>% 
  mutate(new_cell_id = ifelse(str_starts(cell, "B6B6") | str_starts(cell,
                                                 "HLA"),
                              str_c("Eickelberg_", cell),
                              cell)) %>% 
  write_tsv("tables_2/bg_corrected_metadata.tsv.gz")

```
## Subcluster b-cells

```{r}
b_cells <- c(
  "B cell"
)

so_bcells <- subset(so, 
                    subset = cell_types %in% b_cells)
plot_umap(so_bcells, "coarse_clusters")

so_bcells <- NormalizeData(so_bcells)

so_bcells <- FindVariableFeatures(
  so_bcells,
  selection.method = "vst",
  nfeatures = 2000,
  verbose = FALSE
)

so_bcells <- ScaleData(so_bcells, verbose = TRUE)

so_bcells <- RunPCA(so_bcells, 
             npcs = 100, 
             verbose = FALSE)

ElbowPlot(so_bcells, ndims = 100)

# make graphs and use graphs for UMAP
so_bcells <- FindNeighbors(so_bcells, 
                      reduction = "pca", 
                      dims = 1:10, 
                      k.param = 20L)

so_bcells <- RunUMAP(so_bcells, 
              graph = "RNA_snn", 
              min.dist = 0.5)

so_bcells <- FindClusters(so_bcells, 
                   resolution = c(0.1, 0.2, 0.3, 0.5))

so_bcells$refined_clusters <- so_bcells$RNA_snn_res.0.3

Idents(so_bcells) <- "refined_clusters"

plot_umap(so_bcells, "condition")
plot_umap(so_bcells, "refined_clusters")

saveRDS(so_bcells, file.path(object_dir, "so_bcells.rds"))

so_bcells <- readRDS(file.path(object_dir, "so_bcells.rds"))

refined_markers <- FindAllMarkers(so_bcells, 
                                  only.pos = TRUE)

write_tsv(refined_markers, 
          file.path(mkrs_dir, "refined_cluster_markers.tsv"))
```


```{r}
mkrs <- read_tsv(file.path(mkrs_dir,
                           "refined_cluster_markers.tsv"))

topx <- mkrs %>% 
  group_by(cluster) %>% 
  top_n(10, avg_logFC) 
```



```{r, fig.width = 10, fig.height= 10}

p <- DotPlot(so_bcells, 
        features = unique(topx$gene),
        group.by = "refined_clusters") +
  coord_flip() +
  labs(x = "Cluster",
       y = "")

p

save_plot(file.path(fig_dir, 
                    "coarse_cluster_marker_dotplot.pdf"), 
          p, base_height = 24, base_asp = 1)
```

Remove cluster 5 (all mitochondrial markers, and cluster 7, contaminating t-cells. 


```{r}

so <- subset(so_bcells, 
             subset = refined_clusters %in% c(5, 7), 
             invert = TRUE)

so <- FindVariableFeatures(
  so,
  selection.method = "vst",
  nfeatures = 1000,
  verbose = FALSE
)

so <- ScaleData(so, verbose = TRUE)

so <- RunPCA(so, 
             npcs = 50, 
             verbose = FALSE)

ElbowPlot(so, ndims = 100)

# make graphs and use graphs for UMAP
so <- FindNeighbors(so, 
                      reduction = "pca", 
                      dims = 1:15, 
                      k.param = 20L)

so <- RunUMAP(so, 
              graph = "RNA_snn", 
              min.dist = 0.5, 
              spread = 10)

so <- FindClusters(so, 
                   resolution = c(0.1, 0.2, 0.3, 0.5))

so$refined_clusters <- so$RNA_snn_res.0.5

Idents(so) <- "refined_clusters"

plot_umap(so, "condition")
plot_umap(so,
          "refined_clusters",
          label_text = TRUE,
          label_col = "black")

to_plot <- c(
  "refined_clusters",
  "orig.ident",
  "condition"
) 

plt <- map(to_plot, 
    ~plot_umap(so, .x)) %>% 
  plot_grid(plotlist = ., nrow = 1, ncol =3)


save_plot(file.path(fig_dir,
                         paste0("bcell_umap_summary.pdf")),
                plt, nrow = 1, ncol = 3,
                base_asp = 1.2)

saveRDS(so, file.path(object_dir, "so_bcells_v2.rds"))
```

```{r}
so <- readRDS(file.path(object_dir, "so_bcells_v2.rds"))
refined_markers <- FindAllMarkers(so, 
                                  only.pos = TRUE)

write_tsv(refined_markers, 
          file.path(mkrs_dir, "bcell_subcluster_markers.tsv"))

mkrs <- read_tsv(file.path(mkrs_dir,
                           "bcell_subcluster_markers.tsv"))

topx <- mkrs %>% 
  group_by(cluster) %>% 
  top_n(10, avg_logFC) 
```



```{r, fig.width = 10, fig.height= 10}

p <- DotPlot(so, 
        features = unique(topx$gene),
        group.by = "refined_clusters") +
  coord_flip() +
  labs(x = "Cluster",
       y = "")

p

save_plot(file.path(fig_dir, 
                    "bcell_subcluster_marker_dotplot.pdf"), 
          p, base_height = 12, base_asp = 1)
```

```{r}
so$cluster_condition <- str_c(so$condition,
                              "_",so$refined_clusters)

clusters_to_test <- sort(unique(so$refined_clusters))

#clusters_to_test <- clusters_to_test[clusters_to_test != "7"]

Idents(so) <- "cluster_condition"
mkrs <- list()
for (i in seq_along(clusters_to_test)){
  message(clusters_to_test[i]) 
  mkrs[[i]] <- FindMarkers(so, 
              ident.1 = str_c("HLAB6_", clusters_to_test[i]),
              ident.2 = str_c("B6B6_", clusters_to_test[i]), 
              only.pos = FALSE)
}

names(mkrs) <- clusters_to_test

mkrs <- map(mkrs, ~tibble::rownames_to_column(.x, "gene"))
mkrs <- bind_rows(mkrs, .id = "cluster")
mkrs <- filter(mkrs,  p_val_adj < 0.01)
write_tsv(mkrs, 
          file.path(mkrs_dir, "bcell_subcluster_deg_conditions.tsv"))
```

excel spreadsheets

```{r}
deg_genes <- read_tsv(file.path(mkrs_dir, "bcell_subcluster_deg_conditions.tsv"))

write_markers_xlsx(split(deg_genes, deg_genes$cluster),
                   file.path(mkrs_dir, "bcell_subcluster_deg_conditions.xlsx"),
                   between_clusters_description)

deg_genes <- read_tsv(file.path(mkrs_dir, "bcell_subcluster_markers.tsv"))

write_markers_xlsx(split(deg_genes, deg_genes$cluster),
                   file.path(mkrs_dir, "bcell_subcluster_markers.xlsx"))
```

### Subcluster percentages

```{r}
so_soup <- readRDS(file.path(object_dir, "so_souped.rds"))

cell_counts_by_variables <- c(
  "orig.ident",
  "coarse_clusters",
  "cell_types"
)

names(cell_counts_by_variables) <- c(
  "by sample",
  "by cluster",
  "by cell type"
)

mdata <- so_soup@meta.data %>% 
  rownames_to_column("cell")

cell_counts_all_data <- map(cell_counts_by_variables,
    ~group_by(mdata, condition, !!sym(.x)) %>% 
      summarize(n_cells = n()) %>% 
      spread(condition, n_cells, fill = 0L))

write_tsv(bind_rows(cell_counts_all_data, .id = "var"),
          file.path(tbls_dir, "all_data_cell_counts.tsv"))

openxlsx::write.xlsx(cell_counts_all_data, file.path(tbls_dir, "all_data_cell_counts.xlsx"))
```


```{r}
cell_counts_by_variables <- c(
  "orig.ident",
  "refined_clusters"
)

names(cell_counts_by_variables) <- c(
  "by sample",
  "by cluster"
)

mdata <- so@meta.data %>% 
  rownames_to_column("cell")

cell_counts_bcells <- map(cell_counts_by_variables,
    ~group_by(mdata, condition, !!sym(.x)) %>% 
      summarize(n_cells = n()) %>% 
      spread(condition, n_cells, fill = 0L))

write_tsv(bind_rows(cell_counts_bcells, .id = "var"),
          file.path(tbls_dir, "bcells_cell_counts.tsv"))

openxlsx::write.xlsx(cell_counts_bcells, file.path(tbls_dir, "bcells_cell_counts.xlsx"))
```



## Subcluster endothelial cells

```{r}
endo_cells <- c(
  "lung endothelial cell"
)

so_endo <- subset(so, 
                    subset = cell_types %in% endo_cells)
plot_umap(so_endo, "coarse_clusters")

so_endo <- NormalizeData(so_endo)

so_endo <- FindVariableFeatures(
  so_endo,
  selection.method = "vst",
  nfeatures = 2000,
  verbose = FALSE
)

so_endo <- ScaleData(so_endo, verbose = TRUE)

so_endo <- RunPCA(so_endo, 
             npcs = 100, 
             verbose = FALSE)

ElbowPlot(so_endo, ndims = 100)

# make graphs and use graphs for UMAP
so_endo <- FindNeighbors(so_endo, 
                      reduction = "pca", 
                      dims = 1:10, 
                      k.param = 20L)

so_endo <- RunUMAP(so_endo, 
              graph = "RNA_snn", 
              min.dist = 0.5)
plot_umap(so_endo, "condition")

plot_umap(so_endo, "orig.ident")

res_to_test <-  c(0.1, 0.2, 0.3, 0.5)
so_endo <- FindClusters(so_endo, 
                   resolution = res_to_test)

map(paste0("RNA_snn_res.", res_to_test),
    ~plot_umap(so_endo, .x))

so_endo$refined_clusters <- so_endo$RNA_snn_res.0.3

Idents(so_endo) <- "refined_clusters"


plot_umap(so_endo, "refined_clusters")

saveRDS(so_endo, file.path(object_dir, "so_endo.rds"))
```

```{r}
so_endo <- readRDS(file.path(object_dir, "so_endo.rds"))

refined_markers <- FindAllMarkers(so_endo, 
                                  only.pos = TRUE)

write_tsv(refined_markers, 
          file.path(mkrs_dir, "endothelial_subcluster_markers.tsv"))
```


```{r}
mkrs <- read_tsv(file.path(mkrs_dir,
                           "endothelial_subcluster_markers.tsv"))

topx <- mkrs %>% 
  group_by(cluster) %>% 
  top_n(10, avg_logFC) 
```



```{r, fig.width = 10, fig.height= 10}

p <- DotPlot(so_endo, 
        features = unique(topx$gene),
        group.by = "refined_clusters") +
  coord_flip() +
  labs(x = "Cluster",
       y = "")

p

save_plot(file.path(fig_dir, 
                    "endothelial_subcluster_marker_dotplot.pdf"), 
          p, base_height = 24, base_asp = 1)
```

Remove cluster X (single sample)
```{r}
p1 <- plot_umap(so_endo, "orig.ident")
p2 <- plot_umap(so_endo, "refined_clusters")

p <- plot_grid(p1, p2, nrow = 1,ncol = 2)
p
save_plot(file.path(fig_dir, "endothelial_cells_exclude_single_cluster.pdf"),
          p, 
          nrow = 1, 
          ncol = 2,
          base_asp = 1.2)
```

```{r}

so_endo <- subset(so_endo, 
             subset = refined_clusters == 2, 
             invert = TRUE)

so_endo <- FindVariableFeatures(
  so_endo,
  selection.method = "vst",
  nfeatures = 1000,
  verbose = FALSE
)

so_endo <- ScaleData(so_endo, verbose = TRUE)

so_endo <- RunPCA(so_endo, 
             npcs = 50, 
             verbose = FALSE)

ElbowPlot(so_endo, ndims = 100)

# make graphs and use graphs for UMAP
so_endo <- FindNeighbors(so_endo, 
                      reduction = "pca", 
                      dims = 1:15, 
                      k.param = 20L)

so_endo <- RunUMAP(so_endo, 
              dims = 1:15, 
              min.dist = 0.4)

plot_umap(so_endo, "refined_clusters")

so_endo <- FindClusters(so_endo, 
                       resolution = res_to_test)

map(paste0("RNA_snn_res.", res_to_test),
    ~plot_umap(so_endo, .x))

so_endo$refined_clusters <- so_endo$RNA_snn_res.0.2

Idents(so_endo) <- "refined_clusters"

plot_umap(so_endo, "condition")
plot_umap(so_endo,
          "refined_clusters",
          label_text = TRUE,
          label_col = "black")

to_plot <- c(
  "refined_clusters",
  "orig.ident",
  "condition"
) 

plt <- map(to_plot, 
    ~plot_umap(so_endo, .x)) %>% 
  plot_grid(plotlist = ., nrow = 1, ncol =3)


save_plot(file.path(fig_dir,
                         paste0("endothelial_umap_summary.pdf")),
                plt, nrow = 1, ncol = 3,
                base_asp = 1.2)

saveRDS(so_endo, file.path(object_dir, "so_endothelial_v2.rds"))
```

```{r}
endothelial <- readRDS(file.path(object_dir, "so_endothelial_v2.rds"))
refined_markers <- FindAllMarkers(endothelial, 
                                  only.pos = TRUE)

write_tsv(refined_markers, 
          file.path(mkrs_dir, "endothelial_subcluster_markers.tsv"))

mkrs <- read_tsv(file.path(mkrs_dir,
                           "endothelial_subcluster_markers.tsv"))

topx <- mkrs %>% 
  group_by(cluster) %>% 
  top_n(10, avg_logFC) 
```



```{r, fig.width = 10, fig.height= 10}

p <- DotPlot(so_endo, 
        features = unique(topx$gene),
        group.by = "refined_clusters") +
  coord_flip() +
  labs(x = "Cluster",
       y = "")

p

save_plot(file.path(fig_dir, 
                    "endothelial_subcluster_marker_dotplot.pdf"), 
          p, base_height = 12, base_asp = 1)
```

```{r}
so_endo$cluster_condition <- str_c(so_endo$condition,
                              "_",
                              so_endo$refined_clusters)

clusters_to_test <- sort(unique(so_endo$refined_clusters))

#clusters_to_test <- clusters_to_test[clusters_to_test != "7"]

Idents(so_endo) <- "cluster_condition"
mkrs <- list()
for (i in seq_along(clusters_to_test)){
  message(clusters_to_test[i]) 
  mkrs[[i]] <- FindMarkers(so_endo, 
              ident.1 = str_c("HLAB6_", clusters_to_test[i]),
              ident.2 = str_c("B6B6_", clusters_to_test[i]), 
              only.pos = FALSE)
}

names(mkrs) <- clusters_to_test

mkrs <- map(mkrs, ~tibble::rownames_to_column(.x, "gene"))
mkrs <- bind_rows(mkrs, .id = "cluster")
mkrs <- filter(mkrs,  p_val_adj < 0.01)
write_tsv(mkrs, 
          file.path(mkrs_dir, "endothelial_subcluster_deg_conditions.tsv"))
```

excel spreadsheets

```{r}
deg_genes <- read_tsv(file.path(mkrs_dir, "endothelial_subcluster_deg_conditions.tsv"))

write_markers_xlsx(split(deg_genes, deg_genes$cluster),
                   file.path(mkrs_dir, "endothelial_subcluster_deg_conditions.xlsx"),
                   between_clusters_description)

deg_genes <- read_tsv(file.path(mkrs_dir, "endothelial_subcluster_markers.tsv"))

write_markers_xlsx(split(deg_genes, deg_genes$cluster),
                   file.path(mkrs_dir, "endothelial_subcluster_markers.xlsx"))
```



## Subcluster b-cells + Mzb1 b-cells

```{r}
b_cells <- c(
  "B cell",
  "B cell Mzb1+"
)

so_bcells <- subset(so, 
                    subset = cell_types %in% b_cells)
plot_umap(so_bcells, "coarse_clusters")

so_bcells <- NormalizeData(so_bcells)

so_bcells <- FindVariableFeatures(
  so_bcells,
  selection.method = "vst",
  nfeatures = 2000,
  verbose = FALSE
)

so_bcells <- ScaleData(so_bcells, verbose = TRUE)

so_bcells <- RunPCA(so_bcells, 
             npcs = 100, 
             verbose = FALSE)

ElbowPlot(so_bcells, ndims = 100)

# make graphs and use graphs for UMAP
so_bcells <- FindNeighbors(so_bcells, 
                      reduction = "pca", 
                      dims = 1:10, 
                      k.param = 20L)

so_bcells <- RunUMAP(so_bcells, 
              graph = "RNA_snn", 
              min.dist = 0.4)

so_bcells <- FindClusters(so_bcells, 
                   resolution = c(0.1, 0.2, 0.3, 0.5))

so_bcells$refined_clusters <- so_bcells$RNA_snn_res.0.5

Idents(so_bcells) <- "refined_clusters"

plot_umap(so_bcells, "condition")
plot_umap(so_bcells, "refined_clusters")
plot_umap(so_bcells, "cell_types")

saveRDS(so_bcells, file.path(object_dir,
                             "so_bcells_mzb1.rds"))

```



```{r}
get_metadata(so_bcells) %>% 
  mutate(new_cell_id = ifelse(str_starts(cell, "B6B6") | str_starts(cell,
                                                 "HLA"),
                              str_c("Eickelberg_", cell),
                              cell)) %>% 
  write_tsv("tables_2/bcells_mzb1_bg_corrected_metadata.tsv.gz")
```

```{r}
to_plot <- c(
  "orig.ident",
  "condition",
  "cell_types",
  "Mzb1",
  "RNA_snn_res.0.5"
) 

plt <- map(to_plot, 
    ~plot_umap(so_bcells, .x)) %>% 
  plot_grid(plotlist = ., nrow = 3, ncol = 2)


save_plot(file.path(fig_dir,
                         paste0("mzb_bcell_umap_summary.pdf")),
                plt, nrow = 3, ncol = 2,
                base_asp = 1.2)

Idents(so_bcells) <- "RNA_snn_res.0.5"
mkrs <- FindAllMarkers(so_bcells, only.pos = TRUE)

write_tsv(mkrs, 
          file.path(mkrs_dir, "bcells_mzb1_markers_all_data.tsv"))

write_markers_xlsx(split(mkrs, mkrs$cluster), file.path(mkrs_dir, "bcells_mzb1_markers_all_data.xlsx"))
```

